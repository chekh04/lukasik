<div class="container-module box-kits">
    <div class="title-module">
        <span>{{ heading_title }}</span>
    </div>
    <div class="swiper-mod-navigation">
        <div class="swiper-mod-arrow swiper-button-lock swiper-button-disabled prev-prod">
            <i class="up-icon-arrow-left" aria-hidden="true"></i>
        </div>
        <div class="swiper-mod-arrow swiper-button-lock next-prod">
            <i class="up-icon-arrow-right" aria-hidden="true"></i>
        </div>
    </div>
    <div class="swiper swiper-module kits-module kits-slider-{{ module }} kits-type-slider-{{ kits|length > 2 ? '3' : kits|length }}">
        <div class="swiper-wrapper">
            {% for info_kit in kits %}
                <div class="swiper-slide">
                    <div class="row-flex row-kit h-100">
                        <div class="products-kit d-flex">
                            {% for product in info_kit.products %}
                                <div data-kit="{{ info_kit.kit_id }}_{{ info_kit.vk_id }}_{{ product.product_id }}" class="product-kit">
                                    <div class="dflex flex-column kit-item h-100">
                                        <div class="image">
                                            <div class="stickers-ns">
                                                {% if on_off_percent_discount == '1' and product.special %}
                                                    <span class="sticker-ns special">{{ product.skidka|round }} %</span>
                                                {% endif %}
                                            </div>
                                            <a href="{{ product.href }}">
                                                <img class="img-responsive" decoding="async" width="{{ product.width }}" height="{{ product.height }}" loading="lazy" src="{{ product.thumb }}" alt="{{ product.name }}" />
                                            </a>
                                        </div>
                                        <div class="caption dflex flex-column h-100">
                                            <div class="product-name">
                                                <a href="{{ product.href }}">{{ product.name }}</a>
                                            </div>
                                            <div class="price">
                                                {% if not product.special %}
                                                    <span>{{ product.price }}</span>
                                                {% else %}
                                                    <span class="price-old">{{ product.price }}</span>
                                                    <span class="price-new">{{ product.special }}</span>
                                                {% endif %}
                                                {% if product.tax %}
                                                    <span class="price-tax">{{ text_tax }} {{ product.tax }}</span>
                                                {% endif %}
                                            </div>
                                            {% if product.total_prod > 1 %}
                                                <div class="change-kit">
                                                    <button title="{{ button_change_kit }}" data-toggle="tooltip" class="btn btn-change-kit" onclick="getVariantProducts('{{ info_kit.kit_id }}', '{{ info_kit.vk_id }}', '{{ product.product_id }}')" type="button">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 20 20">
                                                            <path stroke="#00509D" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M14.167 1.75 17.5 5.083l-3.333 3.334"/>
                                                            <path stroke="#00509D" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.5 10.166V8.5a3.333 3.333 0 0 1 3.333-3.333H16.5M5.833 18.25 2.5 14.916l3.333-3.333"/>
                                                            <path stroke="#00509D" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.5 9.834V11.5a3.333 3.333 0 0 1-3.333 3.334H3.5"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="product-kit-totals totals_kit_{{ info_kit.kit_id }}_{{ info_kit.vk_id }}">
                            <div class="kit-item dflex h-100">
                                <div class="kit-group-totals dflex">
                                    <div class="kit-discount">-<span class="kit-discount-total">{{ info_kit.discount_kit }}</span></div>
                                    <div class="kit-totals">{{ info_kit.total_kit }}</div>
                                </div>
                                <div class="kit-cart">
                                    <button class="btn btn-general" onclick="kitAddToCart('{{ info_kit.kit_id }}', '{{ info_kit.vk_id }}', '{{ info_kit.product_id }}')" type="button">
                                        <i class="up-icon-22 up-icon-cart" aria-hidden="true"></i>{{ button_kit_cart }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var nx_kit = $('.kits-slider-{{ module }}').closest('.container-module').find('.next-prod')[0];
            var pr_kit = $('.kits-slider-{{ module }}').closest('.container-module').find('.prev-prod')[0];
            var navigation = $('.kits-slider-{{ module }}').closest('.container-module').find('.swiper-mod-navigation')[0];
            var length_kits = $('.kits-slider-{{ module }} .swiper-slide').length;

            const swiperKits = new Swiper('.kits-slider-{{ module }}', {
                watchSlidesVisibility: true,
                watchSlidesProgress: true,
                watchOverflow: true,
                observer: true,
                observeParents: true,
                slidesPerView: 1,
                spaceBetween: 20,
                nested: true,
                speed: 400,
                breakpointsBase: 'container',
                grabCursor: true,
                navigation: {
                    nextEl: nx_kit,
                    prevEl: pr_kit,
                },
                on: {
                    afterInit: function () {
                        setTimeout(function () {
                            $('.kits-slider-{{ module }}').addClass('swiper-visible');
                        }, 500);
                        updateNavigation();
                    },
                    resize: function () {
                        setTimeout(function () {
                            updateNavigation();
                        }, 300);
                    },
                    sliderMove: function () {
                        $('.kits-slider-{{ module }} .swiper-slide-visible').addClass('disabled-swiper-bg');
                    },
                    touchEnd: function () {
                        setTimeout(function () {
                            $('.kits-slider-{{ module }} .swiper-slide-visible').removeClass('disabled-swiper-bg');
                        }, 100);
                    },
                    slideChangeTransitionStart: function () {
                        $('.kits-slider-{{ module }} .swiper-slide-visible').addClass('disabled-swiper-bg');
                    },
                    slideChangeTransitionEnd: function () {
                        $('.kits-slider-{{ module }} .swiper-slide-visible').removeClass('disabled-swiper-bg');
                    },
                },
                breakpoints: {
                    800 : {
                        slidesPerView: 2,
                    },
                    1200: {
                        slidesPerView: length_kits > 2 ? 2.5 : 2,
                    },
                }
            });

            function updateNavigation() {
                var buttons = $('.kits-slider-{{ module }}').closest('.container-module').find('.swiper-mod-navigation .swiper-button-lock');
                if (buttons.length === 2) {
                    $(navigation).addClass('disabled-navigation');
                } else {
                    $(navigation).removeClass('disabled-navigation');
                }
            }
        });
    </script>
</div>
